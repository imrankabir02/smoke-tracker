{% extends 'tracker/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">My Stats</h2>

    {% if no_data %}
        <div class="alert alert-info text-center" role="alert">
            No smoking data logged yet. Start logging to see your stats!
        </div>
    {% else %}
        <!-- Key Metrics -->
        <div class="row text-center mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Today's Smokes</h5>
                        <p class="card-text fs-4">{{ today_smokes }} / {{ daily_goal|default:"-" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">This Week's Smokes</h5>
                        <p class="card-text fs-4">{{ this_week }} / {{ weekly_limit|default:"-" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">This Month's Smokes</h5>
                        <p class="card-text fs-4">{{ this_month }} / {{ monthly_limit|default:"-" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total Smokes</h5>
                        <p class="card-text fs-4">{{ total_smokes }}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row text-center mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Today's Cost</h5>
                        <p class="card-text fs-4">{{ request.user.profile.currency }}{{ today_cost|stringformat:".2f" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">This Week's Cost</h5>
                        <p class="card-text fs-4">{{ request.user.profile.currency }}{{ week_cost|stringformat:".2f" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">This Month's Cost</h5>
                        <p class="card-text fs-4">{{ request.user.profile.currency }}{{ month_cost|stringformat:".2f" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total Cost</h5>
                        <p class="card-text fs-4">{{ request.user.profile.currency }}{{ total_cost|stringformat:".2f" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-center">Today's Smokes</h5>
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-center">This Week's Smokes</h5>
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-center">This Month's Smokes</h5>
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title text-center">Smokes by Trigger</h5>
                                <canvas id="triggerChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title text-center">Mood Impact</h5>
                                <canvas id="moodImpactChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

{{ trigger_labels|json_script:"trigger-labels" }}
{{ trigger_counts|json_script:"trigger-counts" }}
{{ weekly_labels|json_script:"weekly-labels" }}
{{ weekly_counts|json_script:"weekly-counts" }}
{{ monthly_labels|json_script:"monthly-labels" }}
{{ monthly_counts|json_script:"monthly-counts" }}
{{ mood_impact|json_script:"mood-impact" }}
{{ daily_labels|json_script:"daily-labels" }}
{{ daily_counts|json_script:"daily-counts" }}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% if not no_data %}
            const triggerLabels = JSON.parse(document.getElementById('trigger-labels').textContent);
            const triggerCounts = JSON.parse(document.getElementById('trigger-counts').textContent);
            const weeklyLabels = JSON.parse(document.getElementById('weekly-labels').textContent);
            const weeklyCounts = JSON.parse(document.getElementById('weekly-counts').textContent);
            const monthlyLabels = JSON.parse(document.getElementById('monthly-labels').textContent);
            const monthlyCounts = JSON.parse(document.getElementById('monthly-counts').textContent);
            const moodImpact = JSON.parse(document.getElementById('mood-impact').textContent);
            const dailyLabels = JSON.parse(document.getElementById('daily-labels').textContent);
            const dailyCounts = JSON.parse(document.getElementById('daily-counts').textContent);


            // Daily Chart (Line)
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Smokes per Hour',
                        data: dailyCounts,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            // Weekly Chart (Line)
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: weeklyLabels,
                    datasets: [{
                        label: 'Smokes per Day',
                        data: weeklyCounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            // Monthly Chart (Line)
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Smokes per Week',
                        data: monthlyCounts,
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            // Trigger Chart (Pie)
            const triggerCtx = document.getElementById('triggerChart').getContext('2d');
            new Chart(triggerCtx, {
                type: 'pie',
                data: {
                    labels: triggerLabels,
                    datasets: [{
                        label: 'Smokes by Trigger',
                        data: triggerCounts,
                        backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'],
                        borderColor: '#fff',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });

            // Mood Impact Chart (Bar)
            const moodCtx = document.getElementById('moodImpactChart').getContext('2d');
            new Chart(moodCtx, {
                type: 'bar',
                data: {
                    labels: ['Improved', 'Worsened', 'Unchanged'],
                    datasets: [{
                        label: 'Percentage of Logs',
                        data: [moodImpact.improved_percent, moodImpact.worsened_percent, moodImpact.unchanged_percent],
                        backgroundColor: ['rgba(75, 192, 192, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(255, 206, 86, 0.7)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)', 'rgba(255, 206, 86, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return value + '%' } } } },
                    plugins: { legend: { display: false } }
                }
            });
        {% endif %}
    });
</script>
{% endblock %}
